---
title: InnoDB存储引擎索引
date: 2020-08-26 23:41:12
categories: 
           - mysql
tags:
           - 索引
           - InnoDB
---

## 一、B+树索引

> B+树索引可以分为**聚集索引**和**辅助索引**。他们的不同是**叶子结点是否存放一整行的信息**。

### 1.聚集索引

> 按照每张表的主键构建一棵B+树，同时叶子结点中存放的即为整张表的行记录数据，叶子结点（数据页）通过双向链表进行连接。
>
> InnoDB存储引擎表就是索引组织表，每张表只能拥有一个聚集索引，但可以有多个辅助索引。

#### 说明

- 多数情况下，查询优化器 倾向于使用聚集索引，因为可以直接在叶子结点上找到数据。

- 由于定义了数据的逻辑顺序，聚集索引能够特别快地访问针对范围值的查询，也就是对于主键的排序查找和范围查找来说速度非常快。

### 2.辅助索引

> 叶子结点并不包含行记录数据的全部数据。
>
> 叶子节点包含辅助索引键值和书签（primary key）。
>
> 由于InnoDB存储引擎表是索引组织表，所以书签就是相应行数据的聚集索引键。

#### 原理

​	当通过辅助索引来寻找数据时，InnoDB存储引擎会遍历辅助索引并通过叶级别的指针获得指向主键索引的主键，然后再通过主键索引来找到一个完整的行记录。

#### 举例

​	如果在一棵高度为3的辅助索引树中查找数据，需要对这棵辅助索引树做3次IO操作找到指定的书签（主键）；如果聚集索引树的高度同样为3，那么还需要对聚集索引进行3次I/O，找到完整行数所在的数据页。一共需要6次IO操作。

## 二、Cardinality值

### 1.Cardinality的意义

> 表示索引中不重复记录数量的预估值。

#### 高选择性

​	在访问表中高选择性数据时使用B+树索引才有意义。例如性别、地区、类型字段可取值范围很小，选择性很低。

​	Cardinality / n_row_in_table 要尽可能小，否则索引没必要建立。

### 2.Cardinality的统计

> InnoDB对于Cardinality的统计是通过采样进行的,所以不是精确值。

#### 原因

​	生产环境中，索引的更新操作是非常频繁的，且对于数据量很大的表，如果每次更新都要进行Cardinality的统计所需的时间很长，给数据库带来很大复旦，因此通过采样方式。

#### 更新策略

​	INSERT和UPDATE时更新Cardinality。策略为：

- 表中1/16的数据发生变化;
- 变化次数stat_modified_counter>2000000000;

#### 采样过程

- 取得B+树索引中叶子结点的数量，记为A；
- 随机取得B+树索引中的8个叶子结点。统计每个页不同记录的个数，为P1,P2,..,P8;
- 根据采样信息给出Cardinality的预估值 = (P1+P+..+P8)*A/8;

#### 说明

​	每次统计得到的Cardinality值不一定相同。

​	当索引的B+树叶子结点个数小于等于8个时，每次得到的Cardinality值相同。

## 三、B+树索引的使用

### 1.联合索引

> 对表上的多个列进行索引

```sql
CREATE TABLE t (
	a INT,
  b INT,
  KEY idx_a_b (a,b)
)ENGINE=INNODB
/* 先按照a值进行排序，再按照b值进行排序 */
```

#### 使用情况

- 对于WHERE a=xxx AND b=xxx 可以使用这个索引
- 对于WHERE a=xxx 也可以使用这个索引
- 对于WHERE b=xxx 则不可以使用

#### 优点

​	已经对第二个键值进行了排序，很多时候应用程序都需要查询某个用户的购物情况，并按照时间进行排序，使用联合索引可以避免多一次的排序操作。

### 2.覆盖索引

> 从辅助索引中就可以得到查询记录，不需要查询聚集索引中的记录。

#### 原理

​	对于InnoDB存储引擎的辅助索引而言，由于其包含了主键信息，因此其叶子结点存放的数据为（primary key1, primary key2, ..., key1, key2, ... ）。故查询SELECT x FROM table where y=xxx;（只要x和y在辅助索引椰子结点数据内，都可以使用一次辅助联合索引完成）

```sql
SELECT primary key1, primary key2, key2 FROM t WHERE key1=xxx;
```

#### 优点

- 进行一次辅助联合索引加快查询速度
- 对于某些统计问题而言，不会通过聚集索引来进行统计，而会选择辅助索引减少IO操作，一般来说辅助索引数据量小，每一页可以存放的内容多，故树高小，IO效率高。

### 3.优化器选择不使用索引

> 某些情况，优化器并没有选择索引去查找数据，而是通过扫描聚集索引，也就是直接进行全表的扫描来得到数据。这种情况多发于范围查找、JOIN链接操作等情况下。

#### 原理

​	**对于不能进行索引覆盖的情况，优化器选择辅助索引的情况是 : 通过辅助索引查找的数据是少量的。**

​	数据量大的情况下，进行大量数据的范围查找，虽然辅助索引上，数据是有序的，但是 因为不能索引覆盖，所以要再次书签访问来查找聚集索引上的整行数据信息，这时候就变为离散读操作，因为顺序读要远快于离散读，所以直接扫描聚集索引。

### 4.MRR优化

> ​	Muliti-Range Read优化的目的是为了减少磁盘的随机访问，并且将随机访问转化为较为顺序的数据访问，适用于range， ref， eq_ref。

#### 工作方式

​	在查询辅助索引时，首先根据得到的查询结果，按照主键进行排序，并按照主键排序的顺序进行书签查找。

#### 优点

- 可以减少缓冲池中页被替换的次数
- 批量处理对键值的查询操作。
- 查询性能得到极大的提高

### 5.ICP优化

> 取出索引的同时，判断是否可以进行WHERE条件查询，将WHERE的部分过滤操作放在存储引擎层，在某些查询下，可以大大减少上层SQL层对记录的索取，提高数据库整体性能。



## 四、哈希索引

哈希索引能以 O(1) 时间进行查找，但是失去了有序性：

- 无法用于排序与分组；
- 只支持精确查找，无法用于部分查找和范围查找。

InnoDB 存储引擎有一个特殊的功能叫“**自适应哈希索引**”，当某个索引值被使用的非常频繁时，会在 B+Tree 索引之上再创建一个哈希索引，这样就让 B+Tree 索引具有哈希索引的一些优点，比如快速的哈希查找。

## 五、全文检索

> 将存储于数据库的整篇文章中的任意内容信息查找出来的技术。

### 1.倒排索引

> 在辅助表中存储了单词与单词自身在一个或多个文档中所在位置之间的映射。

- inverted file index，其表现形式为{单词，单词所在文档的ID}
- full inverted inndex，其表现形式为{单词 , (单词所在文档的ID , 在文档中的具体位置)}

### 2.InnoDB全文检索

（具体的细节回顾MySQL技术内幕InnoDB存储引擎）

> InnoDB存储引擎从1.2.x版本开始支持全文检索的技术，其采用Full inverted index的方式。

#### 原理

- InnoDB的全文检索表中有两个列：( word, ilist )，ilist=(DocumentID, Position)，其中word字段上设有索引。
- Auxiliary Table为辅助表，还设有红黑树结构实现的FTS Index Cache缓存，来提高全文检索的性能
- 查找条件使用 MATCH AGAINST，而不是普通的 WHERE。